const express = require('express');
const cors = require('cors');
const axios = require('axios');
const { connecter } = require('./bd/connect');
const path = require("path");
const verifierNotifications = require("./cron/notification");
const verifierNotificationsstock = require("./cron/notificationstock");
const cleanupResetPassword = require('./cron/cleanupResetPassword');

const app = express();

// Middleware
app.use(cors({ origin: "*" }));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// // === PROXY ROUTE POUR TRANSACTIONS ===
// const authenticateToken = require('./middleware/auth');


// app.get('/api/proxy/transactions', authenticateToken, async (req, res) => {
//   const { emp_code = '', start_time, end_time, page = 1 } = req.query;
//   const userId = req.user && req.user.id;
//   console.log('userId reÃ§u:', userId); // Log userId
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       console.log('RÃ©sultat SQL pour userId:', userId, results); // Log rÃ©sultat SQL
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         console.log('Aucun token trouvÃ© pour userId:', userId); // Log si pas de token
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       console.log('Token allouÃ© rÃ©cupÃ©rÃ©:', userToken); // Log token allouÃ©
//       try {
//         const response = await axios.get('http://54.37.15.111:80/iclock/api/transactions/', {
//           params: { emp_code, start_time, end_time, page },
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         console.log('RÃ©ponse API externe:', response.data); // Log rÃ©ponse API externe
//         res.json(response.data);
//       } catch (err) {
//         console.error('Erreur API externe:', err.response?.data || err.message); // Log erreur API externe
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });
// // === FIN PROXY ===

// // Proxy pour rÃ©cupÃ©rer la liste des employÃ©s avec le token allouÃ©
// app.get('/api/proxy/employees', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const page = req.query.page || 1; // RÃ©cupÃ©ration du paramÃ¨tre de page depuis la requÃªte
//   console.log('userId reÃ§u:', userId, 'page demandÃ©e:', page);

//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       console.log('RÃ©sultat SQL pour userId:', userId, results);
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         console.log('Aucun token trouvÃ© pour userId:', userId);
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       console.log('Token allouÃ© rÃ©cupÃ©rÃ©:', userToken);
//       try {
//         // Construction de l'URL avec le paramÃ¨tre de page
//         const apiUrl = `http://54.37.15.111:80/personnel/api/employees/?page=${page}`;
//         console.log('URL API avec pagination:', apiUrl);
        
//         const response = await axios.get(apiUrl, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         console.log('RÃ©ponse API externe:', response.data);
//         res.json(response.data);
//       } catch (err) {
//         console.error('Erreur API externe:', err.response?.data || err.message);
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // Voir un employÃ©
// app.get('/api/proxy/employees/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get(`http://54.37.15.111:80/personnel/api/employees/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // CrÃ©er un employÃ©
// app.post('/api/proxy/employees', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.post('http://54.37.15.111:80/personnel/api/employees/', req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // Modifier un employÃ©
// app.patch('/api/proxy/employees/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.patch(`http://54.37.15.111:80/personnel/api/employees/${id}/`, req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // Supprimer un employÃ©
// app.delete('/api/proxy/employees/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.delete(`http://54.37.15.111:80/personnel/api/employees/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // === PROXY DEPARTMENTS ===
// app.get('/api/proxy/departments', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get('http://54.37.15.111:80/personnel/api/departments/', {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.get('/api/proxy/departments/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get(`http://54.37.15.111:80/personnel/api/departments/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.post('/api/proxy/departments', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.post('http://54.37.15.111:80/personnel/api/departments/', req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.patch('/api/proxy/departments/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.patch(`http://54.37.15.111:80/personnel/api/departments/${id}/`, req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.delete('/api/proxy/departments/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.delete(`http://54.37.15.111:80/personnel/api/departments/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // === PROXY AREAS ===
// app.get('/api/proxy/areas', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get('http://54.37.15.111:80/personnel/api/areas/', {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.get('/api/proxy/areas/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get(`http://54.37.15.111:80/personnel/api/areas/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.post('/api/proxy/areas', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.post('http://54.37.15.111:80/personnel/api/areas/', req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.patch('/api/proxy/areas/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.patch(`http://54.37.15.111:80/personnel/api/areas/${id}/`, req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.delete('/api/proxy/areas/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.delete(`http://54.37.15.111:80/personnel/api/areas/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// // === PROXY POSITIONS ===
// app.get('/api/proxy/positions', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get('http://54.37.15.111:80/personnel/api/positions/', {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.get('/api/proxy/positions/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.get(`http://54.37.15.111:80/personnel/api/positions/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.post('/api/proxy/positions', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.post('http://54.37.15.111:80/personnel/api/positions/', req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.patch('/api/proxy/positions/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.patch(`http://54.37.15.111:80/personnel/api/positions/${id}/`, req.body, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// app.delete('/api/proxy/positions/:id', authenticateToken, async (req, res) => {
//   const userId = req.user && req.user.id;
//   const { id } = req.params;
//   if (!userId) {
//     return res.status(401).json({ error: 'Utilisateur non authentifiÃ©' });
//   }
//   connecter((error, connection) => {
//     if (error) {
//       return res.status(500).json({ error: 'Erreur de connexion Ã  la base de donnÃ©es' });
//     }
//     connection.query('SELECT token_allouer FROM users WHERE id = ?', [userId], async (err, results) => {
//       if (err) {
//         return res.status(500).json({ error: 'Erreur lors de la rÃ©cupÃ©ration du token utilisateur' });
//       }
//       if (!results || results.length === 0 || !results[0].token_allouer) {
//         return res.status(403).json({ error: 'Token utilisateur non trouvÃ©' });
//       }
//       const userToken = results[0].token_allouer;
//       try {
//         const response = await axios.delete(`http://54.37.15.111:80/personnel/api/positions/${id}/`, {
//           headers: {
//             'Authorization': `Token ${userToken}`,
//             'Content-Type': 'application/json',
//           },
//         });
//         res.json(response.data);
//       } catch (err) {
//         res.status(err.response?.status || 500).json(err.response?.data || { error: err.message });
//       }
//     });
//   });
// });

// Connexion Ã  la base de donnÃ©es une seule fois
connecter((erreur, pool) => {
    if (erreur) {
        console.error("âŒ Erreur de connexion MySQL :", erreur);
        process.exit(-1);
    } else {
        console.log("âœ… Connexion MySQL Ã©tablie.");
        const PORT = process.env.PORT || 5050;
        app.listen(PORT, '0.0.0.0', () => {
            console.log(`ðŸš€ Serveur dÃ©marrÃ© sur le port ${PORT}.`);
        });
    }
});

// Routes API
const routes = [
    require("./route/utilisateur"),
    require("./route/client"),
    require("./route/categorie"),
    require("./route/unit"),
    require("./route/detailcommande"),
    require("./route/facture"),
    require("./route/facturation"),
    require("./route/fournisseur"),
    require("./route/produit"),
    require("./route/stock"),
    require("./route/vente"),
    require("./route/mail"),
    require("./route/login"),
    require("./route/deconnexion"),
    require("./route/pdfRoutes"),
    require("./route/invoice"),
    require("./route/supplement"),
    require("./route/notification"),
    require("./route/resetPassword"),
    require("./route/planning"),
    require("./route/permissionconge"),
    require("./route/retardabsence"),
    require("./route/ponctualite"),
    require("./route/presenceReport"),
    require("./route/dashboard"),
    require("./route/collection"),
    require("./route/panier"),
    require("./route/commande"),
    require("./route/couleur"),
    require("./route/taille"),
];
setInterval(cleanupResetPassword, 60 * 1000); // toutes les minutes
verifierNotifications();
verifierNotificationsstock();

routes.forEach(route => app.use("/api/v1", route));

// Servir les fichiers PDF
app.use("/factures", express.static(path.join(__dirname, "factures")));
app.use("/pdf", express.static(path.join(__dirname, "pdf")));
app.use("/invoices", express.static(path.join(__dirname, "invoices")));
app.use("/uploads", express.static(path.join(__dirname, "public/uploads")));

module.exports = app;
